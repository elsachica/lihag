stages:
  - build
  - test
  - staging
  - deploy

# Property Service (ACTIVE - ready for deployment)
build_property:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf '%s' "gitlab-ci-token:${CI_JOB_TOKEN}" | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context "${CI_PROJECT_DIR}/services/property" --dockerfile "${CI_PROJECT_DIR}/services/property/Dockerfile" --destination "gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/property:${CI_COMMIT_REF_SLUG}"
    - echo "✓ Successfully built and pushed property:${CI_COMMIT_REF_SLUG}"

  # rules:
  #   - changes:
  #       - services/property/**


test_property:
  stage: test
  image: node:20
  script:
    - cd services/property
    - npm ci
    - npm run lint || echo "No linter configured"
    - npm test || echo "No tests yet"

# Auth Service (commented out - not ready yet)
build_auth:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf '%s' "gitlab-ci-token:${CI_JOB_TOKEN}" | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context "${CI_PROJECT_DIR}/services/auth" --dockerfile "${CI_PROJECT_DIR}/services/auth/Dockerfile" --destination "gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/auth:${CI_COMMIT_REF_SLUG}"
    - echo "✓ Successfully built and pushed auth:${CI_COMMIT_REF_SLUG}"

  # rules:
  #   - changes:
  #       - services/auth/**


test_auth:
  stage: test
  image: node:20
  script:
    - cd services/auth
    - npm ci --include=dev
    - npm test || echo "No tests yet"

# Maintenance Service (commented out - not ready yet)
build_maintenance:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf '%s' "gitlab-ci-token:${CI_JOB_TOKEN}" | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context "${CI_PROJECT_DIR}/services/maintenance" --dockerfile "${CI_PROJECT_DIR}/services/maintenance/Dockerfile.production" --destination "gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/maintenance:${CI_COMMIT_REF_SLUG}"
    - echo "✓ Successfully built and pushed maintenance:${CI_COMMIT_REF_SLUG}"

  # rules:
  #   - changes:
  #       - services/maintenance/**


test_maintenance:
  stage: test
  image: node:20
  script:
    - cd services/maintenance
    - npm ci
    - npm run lint || echo "No linter configured"
    - npm test || echo "No tests yet"

# Notification Service
build_notification:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]   # Viktigt för Kaniko
  script:
    # Konfigurera Docker auth för GitLab Registry
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf '%s' "gitlab-ci-token:${CI_JOB_TOKEN}" | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context "${CI_PROJECT_DIR}/services/notification" --dockerfile "${CI_PROJECT_DIR}/services/notification/Dockerfile" --destination "gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/notification:${CI_COMMIT_REF_SLUG}"
    - echo "✓ Successfully built and pushed notification:${CI_COMMIT_REF_SLUG}"

  # rules:
  #   - changes:
  #       - services/notification/**

test_notification:
  stage: test
  image: node:20
  script:
    - cd services/maintenance
    - npm ci
    - npm run lint || echo "No linter configured"
    - npm test || echo "No tests yet"


# Lihag-frontend (commented out - not ready yet)
build_frontend:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - |
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf '%s' "gitlab-ci-token:${CI_JOB_TOKEN}" | base64)\"}}}" > /kaniko/.docker/config.json

      IMAGE_TAG="${CI_COMMIT_REF_SLUG}"
      IMAGE="${CI_REGISTRY_IMAGE}/lihag-frontend:${IMAGE_TAG}"

      echo "IMAGE_TAG=${IMAGE_TAG}" > build.env
      echo "IMAGE=${IMAGE}" >> build.env

      /kaniko/executor --context "${CI_PROJECT_DIR}/frontend/lihag-frontend" \
        --dockerfile "${CI_PROJECT_DIR}/frontend/lihag-frontend/Dockerfile.production" \
        --destination "${IMAGE}" \
        --snapshotMode=redo \
        --reproducible \
        --build-arg VITE_AUTH_SERVICE_URL="${AUTH_URL}"
    - echo "✓ Successfully built and pushed lihag-frontend:${IMAGE_TAG}"

  # rules:
  #   - changes:
  #       - frontend/lihag-frontend/**


build_admin-frontend:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - |
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf '%s' "gitlab-ci-token:${CI_JOB_TOKEN}" | base64)\"}}}" > /kaniko/.docker/config.json

      IMAGE_TAG="${CI_COMMIT_REF_SLUG}"
      IMAGE="${CI_REGISTRY_IMAGE}/admin-frontend:${IMAGE_TAG}"

      echo "IMAGE_TAG=${IMAGE_TAG}" > build.env
      echo "IMAGE=${IMAGE}" >> build.env


      /kaniko/executor --context "${CI_PROJECT_DIR}/frontend/admin-frontend" --dockerfile "${CI_PROJECT_DIR}/frontend/admin-frontend/Dockerfile" --destination "${IMAGE}" --snapshotMode=redo --reproducible \
      --build-arg VITE_AUTH_SERVICE_URL="${AUTH_URL}"
    - echo "✓ Successfully built and pushed admin-frontend:${IMAGE_TAG}"

  # rules:
  #   - changes:
  #       - frontend/admin-frontend/**

# Kubernetes Deployment
deploy_staging:
  stage: staging
  image:
    name: gcr.io/k8s-skaffold/skaffold:v2.8.0
    entrypoint: ['']
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "staging"'
      when: always
    - when: never

  variables:
    KUBECONFIG_PATH: "/root/.kube/config"
    NAMESPACE: "default"
    PROPERTY_URL: "$PROPERTY_URL"
    AUTH_URL: "$AUTH_URL"
    MAINTENANCE_URL: "$MAINTENANCE_URL"
    DB_CONNECTION_STRING_AUTH: "$DB_CONNECTION_STRING_AUTH"
    DB_CONNECTION_STRING_MAINTENANCE: "$DB_CONNECTION_STRING_MAINTENANCE"
    DB_CONNECTION_STRING_PROPERTY: "$DB_CONNECTION_STRING_PROPERTY"
    DB_CONNECTION_STRING_NOTIFICATION: "$DB_CONNECTION_STRING_NOTIFICATION"
    JWT_PRIVATE_PEM: "$JWT_PRIVATE_PEM"
    JWT_PUBLIC_PEM: "$JWT_PUBLIC_PEM"

  before_script:
    - mkdir -p "$(dirname "${KUBECONFIG_PATH}")"
    - 'test -f "${KUBE_CONFIG_STAGING}" && cp "${KUBE_CONFIG_STAGING}" "${KUBECONFIG_PATH}" || (printf "%s" "${KUBE_CONFIG_STAGING}" | base64 --decode > "${KUBECONFIG_PATH}" 2>/dev/null || printf "%s" "${KUBE_CONFIG_STAGING}" | base64 -D > "${KUBECONFIG_PATH}" 2>/dev/null || (echo "KUBE_CONFIG_STAGING is not a file path and not valid base64" >&2; exit 1))'
    - chmod 600 "${KUBECONFIG_PATH}"
    - kubectl version --client
  script:
    - |
      echo "Testing registry access..."
      echo "Username: ${CI_REGISTRY_USER}"
      echo "Server: gitlab.lnu.se:5050"
      kubectl delete secret regcred -n "${NAMESPACE}" --ignore-not-found || true
      kubectl create secret docker-registry regcred \
        --docker-server=gitlab.lnu.se:5050 \
        --docker-username="${CI_REGISTRY_USER}" \
        --docker-password="${CI_REGISTRY_PASSWORD}" \
        -n "${NAMESPACE}"
      kubectl get secret regcred -n "${NAMESPACE}" -o yaml

    - echo "$JWT_PUBLIC_PEM" > public.pem
    - kubectl create secret generic jwt-public-key --from-file=public.pem=public.pem -n "${NAMESPACE}" --dry-run=client -o yaml | kubectl apply -f -

    - |
      kubectl create secret generic lihag-env-vars \
        --from-literal=PROPERTY_URL="${PROPERTY_URL}" \
        --from-literal=AUTH_URL="${AUTH_URL}" \
        --from-literal=MAINTENANCE_URL="${MAINTENANCE_URL}" \
        --from-literal=DB_CONNECTION_STRING_AUTH="${DB_CONNECTION_STRING_AUTH}" \
        --from-literal=DB_CONNECTION_STRING_MAINTENANCE="${DB_CONNECTION_STRING_MAINTENANCE}" \
        --from-literal=DB_CONNECTION_STRING_PROPERTY="${DB_CONNECTION_STRING_PROPERTY}" \
        --from-literal=DB_CONNECTION_STRING_NOTIFICATION="${DB_CONNECTION_STRING_NOTIFICATION}" \
        --from-literal=JWT_PRIVATE_PEM="${JWT_PRIVATE_PEM}" \
        --from-literal=JWT_PUBLIC_PEM="${JWT_PUBLIC_PEM}" \
        --from-literal=NODE_ENV="${NODE_ENV}" \
        --from-literal=RABBITMQ_URL="${RABBITMQ_URL}" \
        --from-literal=RABBITMQ_DEFAULT_USER="${RABBITMQ_DEFAULT_USER}" \
        --from-literal=RABBITMQ_DEFAULT_PASS="${RABBITMQ_DEFAULT_PASS}" \
        --from-literal=SMTP_HOST="${SMTP_HOST}" \
        --from-literal=SMTP_PORT="${SMTP_PORT}" \
        --from-literal=SMTP_USER="${SMTP_USER}" \
        --from-literal=SMTP_PASS="${SMTP_PASS}" \
        --from-literal=SMTP_FROM="${SMTP_FROM}" \
        --from-literal=ADMIN_EMAIL="${ADMIN_EMAIL}" \
        -n "${NAMESPACE}" \
        --dry-run=client -o yaml | kubectl apply -f -

    - |
      skaffold deploy --profile production \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/lihag-frontend:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/auth:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/property:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/maintenance:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/admin-frontend:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/notification:$CI_COMMIT_REF_SLUG

    - kubectl get deployments -n "${NAMESPACE}" || true
    - kubectl get pods -n "${NAMESPACE}" -o wide || true

    - echo "✓ Deployment complete!"

  environment:
    name: staging

deploy_production:
  stage: deploy
  image:
    name: gcr.io/k8s-skaffold/skaffold:v2.8.0
    entrypoint: ['']
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master"'
      when: always
    - when: never
  variables:
    KUBECONFIG_PATH: "/root/.kube/config"
    NAMESPACE: "default"
    PROPERTY_URL: "$PROPERTY_URL"
    AUTH_URL: "$AUTH_URL"
    MAINTENANCE_URL: "$MAINTENANCE_URL"
    DB_CONNECTION_STRING_AUTH: "$DB_CONNECTION_STRING_AUTH"
    DB_CONNECTION_STRING_MAINTENANCE: "$DB_CONNECTION_STRING_MAINTENANCE"
    DB_CONNECTION_STRING_PROPERTY: "$DB_CONNECTION_STRING_PROPERTY"
    DB_CONNECTION_STRING_NOTIFICATION: "$DB_CONNECTION_STRING_NOTIFICATION"
    JWT_PRIVATE_PEM: "$JWT_PRIVATE_PEM"
    JWT_PUBLIC_PEM: "$JWT_PUBLIC_PEM"
  before_script:
    - mkdir -p "$(dirname "${KUBECONFIG_PATH}")"
    - 'test -f "${KUBE_CONFIG_PRODUCTION}" && cp "${KUBE_CONFIG_PRODUCTION}" "${KUBECONFIG_PATH}" || (printf "%s" "${KUBE_CONFIG_PRODUCTION}" | base64 --decode > "${KUBECONFIG_PATH}" 2>/dev/null || printf "%s" "${KUBE_CONFIG_PRODUCTION}" | base64 -D > "${KUBECONFIG_PATH}" 2>/dev/null || (echo "KUBE_CONFIG_PRODUCTION is not a file path and not valid base64" >&2; exit 1))'
    - chmod 600 "${KUBECONFIG_PATH}"
    - kubectl version --client
  script:
    - |
      echo "Testing registry access..."
      echo "Username: ${CI_REGISTRY_USER}"
      echo "Server: gitlab.lnu.se:5050"
      kubectl delete secret regcred -n "${NAMESPACE}" --ignore-not-found || true
      kubectl create secret docker-registry regcred \
        --docker-server=gitlab.lnu.se:5050 \
        --docker-username="${CI_REGISTRY_USER}" \
        --docker-password="${CI_REGISTRY_PASSWORD}" \
        -n "${NAMESPACE}"
      kubectl get secret regcred -n "${NAMESPACE}" -o yaml

    - echo "$JWT_PUBLIC_PEM" > public.pem
    - kubectl create secret generic jwt-public-key --from-file=public.pem=public.pem -n "${NAMESPACE}" --dry-run=client -o yaml | kubectl apply -f -

    - |
      kubectl create secret generic lihag-env-vars \
        --from-literal=PROPERTY_URL="${PROPERTY_URL}" \
        --from-literal=AUTH_URL="${AUTH_URL}" \
        --from-literal=MAINTENANCE_URL="${MAINTENANCE_URL}" \
        --from-literal=DB_CONNECTION_STRING_AUTH="${DB_CONNECTION_STRING_AUTH}" \
        --from-literal=DB_CONNECTION_STRING_MAINTENANCE="${DB_CONNECTION_STRING_MAINTENANCE}" \
        --from-literal=DB_CONNECTION_STRING_PROPERTY="${DB_CONNECTION_STRING_PROPERTY}" \
        --from-literal=DB_CONNECTION_STRING_NOTIFICATION="${DB_CONNECTION_STRING_NOTIFICATION}" \
        --from-literal=JWT_PRIVATE_PEM="${JWT_PRIVATE_PEM}" \
        --from-literal=JWT_PUBLIC_PEM="${JWT_PUBLIC_PEM}" \
        --from-literal=NODE_ENV="${NODE_ENV}" \
        --from-literal=RABBITMQ_URL="${RABBITMQ_URL}" \
        --from-literal=RABBITMQ_DEFAULT_USER="${RABBITMQ_DEFAULT_USER}" \
        --from-literal=RABBITMQ_DEFAULT_PASS="${RABBITMQ_DEFAULT_PASS}" \
        --from-literal=SMTP_HOST="${SMTP_HOST}" \
        --from-literal=SMTP_PORT="${SMTP_PORT}" \
        --from-literal=SMTP_USER="${SMTP_USER}" \
        --from-literal=SMTP_PASS="${SMTP_PASS}" \
        --from-literal=SMTP_FROM="${SMTP_FROM}" \
        --from-literal=ADMIN_EMAIL="${ADMIN_EMAIL}" \
        -n "${NAMESPACE}" \
        --dry-run=client -o yaml | kubectl apply -f -

    - |
      skaffold deploy --profile production \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/lihag-frontend:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/auth:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/property:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/maintenance:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/admin-frontend:$CI_COMMIT_REF_SLUG \
        --images gitlab.lnu.se:5050/2dv013/student/team-2025-07-4chics/lihag-system/notification:$CI_COMMIT_REF_SLUG

    - kubectl get deployments -n "${NAMESPACE}" || true
    - kubectl get pods -n "${NAMESPACE}" -o wide || true

    - echo "✓ Deployment complete!"

  environment:
    name: production